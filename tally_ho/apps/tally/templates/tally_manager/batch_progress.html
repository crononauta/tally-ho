{% extends 'base.html' %}

{% load i18n %}
{% load js %}
{% load eztables %}

{% block content %}

<h1>{% trans 'Import progress' %}</h1>

<h2>{% trans 'Subconstituencies import progress' %}</h2>
<div id="progressbar1"></div>

<div class="batch">
    <p>{% trans "Total elements" %}: <span id="offset1">{{ offset }}</span>/<span id="total1">{{ subconst_file_lines }}</span></p>
</div>

<h2>{% trans 'Centers import progress' %}</h2>
<div id="progressbar2"></div>

<div class="batch">
    <p>{% trans "Total elements" %}: <span id="offset2">{{ offset }}</span>/<span id="total2">{{ centers_file_lines }}</span></p>
</div>

<div id="route" class="hidden" style="display:none">{{ request.path }}</div>
<div id="route_destination" style="display:none">{% url 'tally-manager' %}</div>
<div id="errors_number" style="display:none">0</div>

{% endblock %}

{% block styles %}
    {{ block.super }}
      <link rel="stylesheet" href="{{ STATIC_URL }}css/jquery-ui.min.css" />
{% endblock %}

{% block javascript %}
<script type="text/javascript" src="{{ STATIC_URL }}js/jquery-1.11.0.min.js"></script>
{% django_js %}
<script src="{{ STATIC_URL }}js/jquery-ui.min.js"></script>
<script type="text/javascript">

var currentStep = 0;

//STEP 1
var elementsProcessed1 = parseInt($('#offset1').html());
var total1 = parseInt($('#total1').html());

$('#progressbar1').progressbar({
    value: false,
    max: total1
});

//STEP 2
var elementsProcessed2 = parseInt($('#offset2').html());
var total2 = parseInt($('#total2').html());

$('#progressbar2').progressbar({
    value: false,
    max: total2
});

$(document).ready(function() {
    currentStep = 1;
    doRequest();
});

function doRequest() {
    elementsProcessed = parseInt($('#offset' + currentStep ).html());
    total = parseInt($('#total' + currentStep).html());
    if (elementsProcessed < total) {
        $.ajax({
            url: $('#route').html(),
            //    timeout: 30000,
            type: 'POST',
            data: {
                offset: $('#offset' + currentStep).html(),
                step: currentStep
            },
            success: function (data) {
                if (data.status == 'OK') {
                    console.log(data.elements_processed)
                    elementsProcessed += data.elements_processed;
                    $('#offset' + currentStep).html(elementsProcessed);
                    $('#progressbar' + currentStep).progressbar('option', 'value', elementsProcessed);
                    doRequest();
                }
            }
        });
    }
    else {
        console.log("ENTRA");
        if (currentStep < 2) {
            currentStep += 1;
            doRequest();
        }
        //if (parseInt($('#errors_number').html()) > 0) {
        //    location.href = $("#route_destination").html() + '?errors=' + parseInt($('#errors_number').html());
        //}
        //else {
        //    location.href = $("#route_destination").html();
        //}
    }
}
</script>
{% endblock %}
